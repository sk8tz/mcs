#
# IMPORTANT: this test runner is right now incompatible with existing 
# test runner (xslttest.exe).
#
# "make -f Makefile.mstest" prepares automated download and build for 
# MainSoft tests.
#
# "make -f Makefile.mstest run-test" executes the test and reports the total
# diff numbers to "diffreport.txt".
#

RUNTIME = mono
MCS_RUNTIME =
MCS = mcs
TESTS = testsuite/TESTS/Xalan_Conformance_Tests/whitespace/whitespace35.xsl
RESULTS = testsuite/TESTS/ExpectedResults
TEST_ARCHIVE = xslt-testsuite-03.ZIP
RESULTS_ARCHIVE = mono-xslttest-ExpectedResults.zip

alltest.exe : alltest.cs $(TESTS) $(RESULTS)
	$(MCS_RUNTIME) $(MCS) alltest.cs

$(TESTS) : $(TEST_ARCHIVE) simplify.xsl
	unzip -n $(TEST_ARCHIVE)
	xsltproc simplify.xsl testsuite/TESTS/catalog.xml > testsuite/TESTS/catalog-out.xml

$(RESULTS) : $(RESULTS_ARCHIVE)
	unzip -n -d testsuite/TESTS $(RESULTS_ARCHIVE)

$(TEST_ARCHIVE) :
	wget http://www.oasis-open.org/committees/download.php/9584/$(TEST_ARCHIVE)

$(RESULTS_ARCHIVE) :
	wget http://monkey.workarea.jp/mono/xml/$(RESULTS_ARCHIVE)

run-test :
	$(RUNTIME) alltest.exe Results
	diff -r -q testsuite/TESTS/ExpectedResults testsuite/TESTS/Results > diffreport.txt

clean :
	rm -rf testsuite/TESTS/Reports
	rm diffreport.txt alltest.exe

# Be careful to use it!
distclean :
	rm -rf testsuite
	rm diffreport.txt alltest.exe $(TEST_ARCHIVE) $(RESULTS_ARCHIVE)
